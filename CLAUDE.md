# Claude Instructions

## Синхронизация между Claude-клиентами (КРИТИЧЕСКИ ВАЖНО!)

Эта система обеспечивает синхронизацию между:
- **Local Claude Code** (терминал)
- **claude.ai/code** (веб-версия CC)
- **claude.ai** (веб-чат)

### Протокол синхронизации

#### В НАЧАЛЕ каждой сессии:
```bash
# 1. Обновить репозиторий
git pull

# 2. Прочитать статус проекта
cat sync/SYNC_STATUS.md
```

#### В КОНЦЕ каждой сессии:
```bash
# 1. Обновить sync/SYNC_STATUS.md (добавить что сделано)
# 2. Закоммитить и запушить
git add sync/ && git commit -m "sync: update session status" && git push
```

### Формат sync/SYNC_STATUS.md

```markdown
# Project Sync Status

## Last Update
- **Date**: YYYY-MM-DD HH:MM
- **Environment**: Local CC | claude.ai/code | claude.ai
- **Author**: [имя]

## Current State
- В работе: [что сейчас делается]
- Завершено: [что готово]
- Блокеры: [если есть]

## Next Steps
1. [следующий шаг]
2. [ещё шаг]

## Session Log
### YYYY-MM-DD HH:MM (Environment)
- Сделано: ...
- Файлы: ...
```

### Активные проекты

| Проект | Путь | Sync файл |
|--------|------|-----------|
| artvision-data | `/Users/antonk/artvision-data` | `sync/SYNC_STATUS.md` |
| artvision-tg-bot | `/Users/antonk/artvision-tg-bot` | `sync/SYNC_STATUS.md` |
| devops-agent | `/Users/antonk/devops-agent` | `sync/SYNC_STATUS.md` |

> `artvision-data-memo` удалён (бэкап: `~/.artvision-data-memo-backup`)

### Аккаунты и роли

**Текущий режим:** Все аккаунты с полными правами (общий доступ)

| Аккаунт | Роль | Сотрудники | Текущие права |
|---------|------|------------|---------------|
| justtrance@gmail.com | Основной | 2 человека | Полные |
| adw.artvision.pro@gmail.com | Рабочий | 3-й сотрудник | Полные (пока) |

**Планируемое разделение (на будущее):**

```
justtrance@gmail.com — ОСНОВНОЙ
├── Git: push/pull/merge
├── SYNC_STATUS.md: read/write
└── Роль: Admin/Maintain в GitHub

adw.artvision.pro@gmail.com — ОГРАНИЧЕННЫЙ (планируется)
├── Git: pull + создание PR (без прямого push в main)
├── SYNC_STATUS.md: read (обновление через PR)
└── Роль: Write в GitHub (требует review для merge)
```

**Важно про облако Anthropic:**
- Сессии Claude Code синхронизируются автоматически внутри ОДНОГО аккаунта
- Между разными аккаунтами сессии НЕ видны — используй sync/SYNC_STATUS.md
- Для полной прозрачности между аккаунтами — обновляй SYNC_STATUS.md через git

### Репозиторий агентов (100+ штук)

**URL:** https://github.com/artvision-agency/sub-agents.directory
**Локально:** `/Users/antonk/sub-agents.directory`

| Категория | Примеры агентов |
|-----------|-----------------|
| 01-core-development | api-designer, backend-developer, frontend-developer, fullstack |
| 02-language-specialists | angular, django, laravel, nextjs, golang, python, php |
| 03-infrastructure | devops, kubernetes, terraform, cloud-architect, sre |
| 04-quality-security | code-reviewer, qa-expert, security-auditor, performance-engineer |
| 05-data-ai | data-engineer, ml-engineer, llm-architect, prompt-engineer |
| 06-developer-experience | documentation-engineer, refactoring-specialist, mcp-developer |
| 07-specialized-domains | seo-specialist, fintech, blockchain, game-developer |
| 08-business-product | product-manager, technical-writer, ux-researcher |
| 09-meta-orchestration | multi-agent-coordinator, workflow-orchestrator, task-distributor |
| 10-research-analysis | competitive-analyst, market-researcher, trend-analyst |

**Использование:** читать `.md` файлы из `content/[категория]/[агент].md`

### Для claude.ai (веб-чат без доступа к файлам)

1. Загрузи `sync/SYNC_STATUS.md` в **Project Knowledge**
2. Или скопируй содержимое в начало разговора
3. В конце сессии — скопируй обновлённый статус обратно в файл через другой клиент

---

## Восстановление оборванных сессий Claude Code

При logout или сбое сети сессии Claude Code обрываются. Для их восстановления:

### Команды
```bash
claude-sessions              # Показать последние 20 сессий
claude-sessions --interrupted  # Только оборванные (красные)
claude-sessions --resume 3   # Восстановить сессию #3
claude-sessions --all        # Все сессии
cs                           # Короткий alias
```

### Встроенные команды Claude
```bash
claude --resume              # Интерактивный выбор сессии
claude --continue            # Продолжить последнюю сессию
```

### Статусы
- 🔴 **INTERRUPTED** — сессия оборвана (logout, сбой)
- 🟢 **completed** — сессия завершена нормально

> Скрипт: `~/.claude/scripts/claude-sessions.py`

---

## Temporary Scripts

When creating temporary scripts that perform temporary tasks but are not
part of the final project (e.g., data migration scripts, one-time setup
scripts, testing utilities), place them in the `.claude_temp_scripts`
folder to keep the project clean and organized.

## Date Awareness

При запросах с временными указателями ("сейчас", "вчера", "завтра", "на этой неделе", "в этом месяце", "recently", "current", "latest" и т.д.):
1. Проверь текущую дату из системного контекста (env)
2. Используй правильный год в поисковых запросах
3. Не полагайся на knowledge cutoff — всегда ищи актуальную информацию

---

## ОПТИМИЗАЦИЯ ИЗОБРАЖЕНИЙ — ОБЯЗАТЕЛЬНО!

При создании HTML-презентаций, лендингов, отчётов с изображениями:

### Автоматические правила
1. **Максимальный размер HTML файла:** 500KB
2. **Максимальный размер изображения:** 100KB после сжатия
3. **Ширина скриншотов:** 800px максимум
4. **JPEG качество:** 70-80%

### Процесс (ОБЯЗАТЕЛЬНЫЙ!)
```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: ОПТИМИЗАЦИЯ ИЗОБРАЖЕНИЙ                             │
│  ──────────────────────────────────                         │
│  • sips -Z 800 для ресайза до 800px                         │
│  • JPEG: качество 70%                                       │
│  • Проверить что каждый файл <100KB                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 2: ВСТРАИВАНИЕ В HTML                                  │
│  ──────────────────────────                                 │
│  • base64 -i image.png для конвертации                      │
│  • data:image/png;base64,... или data:image/jpeg;base64,... │
│  • Файл должен быть САМОДОСТАТОЧНЫМ                         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 3: ПРОВЕРКА                                            │
│  ──────────────────                                         │
│  • ls -lh file.html — должен быть <500KB                    │
│  • Открыть и проверить качество визуально                   │
└─────────────────────────────────────────────────────────────┘
```

### Команды для оптимизации
```bash
# Сжать PNG до 800px
sips -Z 800 image.png --out optimized.png

# Сжать JPEG до 800px + качество 70%
sips -Z 800 -s formatOptions 70 image.jpg --out optimized.jpg

# Конвертировать в base64
base64 -i optimized.png | tr -d '\n'
```

### Агент
Используй `image-optimizer` агента для автоматической оптимизации.

---

## АВТОНОМНЫЕ HTML ФАЙЛЫ — ОБЯЗАТЕЛЬНО!

При создании HTML файлов для отправки клиентам (презентации, отчёты, лендинги):

### ВСЕГДА создавать ПОЛНОСТЬЮ автономные файлы

**ЗАПРЕЩЕНО использовать внешние зависимости:**
- ❌ CDN (Tailwind, Bootstrap, jQuery и т.д.)
- ❌ Google Fonts / внешние шрифты
- ❌ Внешние изображения (http://...)
- ❌ Любые `<script src="http...">` или `<link href="http...">`

### Процесс создания автономного HTML

```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: CSS/JS — ВСТРОИТЬ INLINE                            │
│  ────────────────────────────────                           │
│  • Tailwind: скачать и вставить в <script>                  │
│  • Bootstrap: скачать минифицированный CSS в <style>        │
│  • Любые библиотеки — inline                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 2: ШРИФТЫ — СИСТЕМНЫЕ                                  │
│  ────────────────────────                                   │
│  • Заменить Google Fonts на системный стек:                 │
│    font-family: -apple-system, BlinkMacSystemFont,          │
│    'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 3: ИЗОБРАЖЕНИЯ — BASE64                                │
│  ─────────────────────────────                              │
│  • Использовать image-optimizer агента                      │
│  • Встроить как data:image/...;base64,...                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 4: ПРОВЕРКА АВТОНОМНОСТИ                               │
│  ──────────────────────────────                             │
│  • grep -oE 'https?://[^"'\''> ]+' file.html                │
│  • Не должно быть внешних URL (кроме ссылок в контенте)     │
│  • Отключить интернет и открыть — должен работать!          │
└─────────────────────────────────────────────────────────────┘
```

### Команды для создания автономного файла

```bash
# Скачать Tailwind для встраивания
curl -sL "https://cdn.tailwindcss.com" -o /tmp/tailwind.js

# Проверить внешние зависимости
grep -oE 'https?://[^"'\''> ]+' file.html | sort -u

# Размер файла
ls -lh file.html
```

### Триггерные слова пользователя

Если пользователь пишет одно из этих — файл ОБЯЗАН быть автономным:
- "отправить клиенту"
- "для клиента"
- "самодостаточный"
- "автономный"
- "без интернета"
- "offline"
- "standalone"

### ⚠️ КРИТИЧНО: Мобильная совместимость

**Tailwind JS runtime (CDN) НЕ РАБОТАЕТ на iOS Safari!**

При создании HTML для клиентов:
- ❌ НИКОГДА не использовать `<script src="cdn.tailwindcss.com">`
- ✅ Использовать предкомпилированный CSS (Tailwind 2.x или извлечённые классы)
- ✅ Или писать inline CSS / обычный CSS

**Процесс для мобильной совместимости:**
```bash
# 1. Скачать Tailwind 2.x CSS (имеет готовый CSS)
curl -sL "https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" -o tailwind2.css

# 2. Извлечь только нужные классы (уменьшить размер)
# или встроить весь CSS в <style>

# 3. Убрать ВСЕ внешние скрипты
```

---

## СОЗДАНИЕ ВЕБ-СТРАНИЦ — ОБЯЗАТЕЛЬНЫЙ WORKFLOW

### Когда применяется:
- Создание/редизайн HTML страниц
- Перенос контента с одного сайта на другой
- Создание шаблонов страниц
- Любая задача "сделай страницу как..."

### ОБЯЗАТЕЛЬНЫЕ ШАГИ (для ВСЕХ проектов!):

```
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 1: ПАРСИНГ КОНТЕНТА (100% полнота!)                    │
│  ──────────────────────────────────────                     │
│  • WebFetch исходной страницы                               │
│  • Запросить ВСЕ блоки: H1, ВСЕ H2, ВСЕ списки, ВСЕ тексты  │
│  • НЕ сокращать, НЕ "основные моменты" — ДОСЛОВНО           │
│  • Если контент большой — запросить частями                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 2: ВЫЗОВ frontend-developer (ОБЯЗАТЕЛЬНО!)             │
│  ──────────────────────────────────────────────             │
│  Task(                                                      │
│    subagent_type = "frontend-developer",                    │
│    prompt = "ПОЛНЫЙ контент + структура/стили эталона"      │
│  )                                                          │
│  • Передать 100% контента — ни слова меньше!                │
│  • Указать CSS/структуру эталона если есть                  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  ШАГ 3: ПРОВЕРКА ПОЛНОТЫ                                    │
│  ──────────────────────                                     │
│  • Открыть в браузере                                       │
│  • Сверить количество блоков с оригиналом:                  │
│    - Сколько H2 секций?                                     │
│    - Сколько FAQ вопросов?                                  │
│    - Сколько карточек/преимуществ?                          │
│    - Есть ли все кейсы/примеры?                             │
│  • Если расхождение — исправить!                            │
└─────────────────────────────────────────────────────────────┘
```

### ЗАПРЕЩЕНО:
- ❌ Сокращать контент ("основные моменты", "ключевые блоки")
- ❌ Передавать контент в prompt текстом БЕЗ проверки полноты
- ❌ Создавать страницу без вызова frontend-developer
- ❌ Не проверять результат на соответствие оригиналу

### Чек-лист коммерческих страниц:
| Блок | Обязателен |
|------|------------|
| Hero + H1 | ✅ |
| Описание услуги | ✅ |
| Преимущества / Почему мы | ✅ |
| Цены / Тарифы | ✅ |
| FAQ (≥5 вопросов) | ✅ |
| Кейсы / Примеры работ | ⚠️ если есть |
| Форма обратной связи | ✅ |
| Контакты (телефон, email, адрес) | ✅ |
| CTA кнопки | ✅ |

---

## ПЛАТНЫЕ API И ДЕНЬГИ — СТРОГИЕ ПРАВИЛА

### АБСОЛЮТНЫЙ ЗАПРЕТ без явного подтверждения:

1. **НИКОГДА не вызывать платные API автоматически:**
   - Topvisor: `checker/go`, любые методы списания
   - Любые сервисы с балансом (Яндекс.Директ, API рекламных систем)
   - Отправка SMS, email-рассылки
   - Любые операции, которые тратят деньги

2. **Перед ЛЮБЫМ платным вызовом ОБЯЗАТЕЛЬНО:**
   - Показать пользователю ТОЧНО какой запрос будет выполнен
   - Показать расчёт стоимости операции
   - Показать какие проекты/сущности затронет
   - Дождаться ЯВНОГО подтверждения: "да", "запускай", "подтверждаю"

3. **Формат запроса подтверждения:**
   ```
   ПЛАТНАЯ ОПЕРАЦИЯ

   Действие: [что будет сделано]
   Затронет: [какие проекты/сущности]
   Стоимость: [расчёт в рублях]

   Подтвердить? (напиши "да" для выполнения)
   ```

4. **Если не уверен — НЕ ДЕЛАЙ:**
   - Лучше спросить лишний раз, чем потратить чужие деньги
   - При любых сомнениях — остановиться и уточнить

5. **После ошибки с деньгами:**
   - Немедленно сообщить пользователю
   - Показать что именно потрачено
   - Не пытаться скрыть или преуменьшить

### Платные сервисы в проекте:
- **Topvisor** (tokens.json): проверка позиций, API
- **Яндекс API**: если будет подключен

---

## Git Auto-Commit Rules

После изменения файлов (Write, Edit) автоматически выполняй:
1. `git add` для изменённых файлов
2. `git commit` с понятным сообщением на английском (что изменено и зачем)
3. `git push` в remote

Формат коммита:
```
<type>: <short description>

Co-Authored-By: Claude <noreply@anthropic.com>
```

Типы: feat, fix, docs, refactor, style, chore

Исключения (НЕ коммитить автоматически):
- Файлы с секретами (.env, credentials, keys) — кроме tokens.json
- Временные файлы (.claude_temp_scripts/)
- Если пользователь явно просит не коммитить

Примечание: tokens.json коммитить автоматически (репо приватный)

### Правило для токенов и секретов
При изменении tokens.json или добавлении новых API ключей:
1. Сообщить пользователю что изменилось
2. Спросить подтверждение на коммит
3. После подтверждения — закоммитить с понятным описанием

---

## АГЕНТЫ И ОПТИМИЗАЦИЯ ТОКЕНОВ

### Установленные агенты

#### 🌍 Глобальные агенты (~/.claude/agents/)
Работают во всех проектах:

| Агент | Триггер | Назначение |
|-------|---------|------------|
| **token-guardian** | Автоматически при больших задачах | Анализ задачи, оценка токенов, оптимальная стратегия |
| **sysadmin-orchestrator** | "проверь инфраструктуру", "валидируй токены" | Мониторинг VPS, SSH, API, бэкапы |
| **frontend-developer** | "создай страницу", "сверстай" | Frontend разработка (HTML/CSS/JS) |
| **seo-analyzer** | "SEO аудит" | SEO анализ и рекомендации |
| **landing-page-agent** | "создай лендинг" | Копирайтинг для лендингов |
| **api-integration-specialist** | "интеграция API" | REST/GraphQL интеграции |
| **data-engineer** | "ETL", "data pipeline" | Обработка данных |

#### 🎨 Artvision-специфичные агенты (artvision-data/.claude-agents/)
Только для проекта artvision-data:

```
Цепочка Universal Page Generator:
frontend-developer → code-reviewer → image-optimizer →
ui-comprehensive-tester → task-completion-validator
```

### ⚠️ ВАЖНО: Как работают агенты (не путать!)

**Агент = Claude + Системный промпт**

Агент НЕ имеет суперспособностей. Это тот же Claude, но с инструкцией фокусироваться на определённой области.

#### Что агент НЕ делает автоматически:
| Ожидание | Реальность |
|----------|------------|
| Сам парсит сайты | ❌ Надо явно дать инструменты или данные |
| Сам вызывает API | ❌ Надо написать код или дать доступ |
| Знает актуальные данные | ❌ Знает только до knowledge cutoff |
| Имеет "суперспособности" | ❌ Это тот же Claude с промптом |

#### Что агент ДЕЛАЕТ лучше:
- **Фокус** — направлен на конкретную область (SEO, frontend, etc.)
- **Терминология** — использует правильные термины
- **Структура** — знает как оформить результат
- **Приоритеты** — понимает что важно в своей области

#### Гибридный подход (РЕКОМЕНДУЕТСЯ):
```
1. Собрать РЕАЛЬНЫЕ данные (парсинг, API)
2. Передать данные агенту в промпте
3. Агент анализирует ФАКТЫ, не гадает
```

**Пример ошибки (29.01.2026):**
- SEO-агент без данных сказал: "0% сайтов имеют description"
- Реальный парсинг показал: 9 из 9 сайтов имеют description
- **Урок:** Агент без данных = галлюцинации

**Скрипт гибридного аудита:**
```bash
python3 artvision-data/scripts/hybrid-seo-audit.py --all
```
Создаёт JSON с фактами + промпт для агента.

### Защита от перерасхода токенов

**Проблема 24-25.01.2026**: 3.4M токенов за 2 дня из-за чтения огромных файлов

**Решение** (установлено 26.01.2026):

#### Хуки (~/.claude/hooks/)
- `pre-read.sh` — блокирует чтение файлов >10K строк
- `context-monitor.sh` — предупреждает при переполнении контекста
- См. `~/.claude/hooks/README.md`

#### Token Guardian агент
- Анализирует задачи ДО выполнения
- Предлагает Grep вместо Read для больших файлов
- Рекомендует Task tool для изоляции контекста
- См. `~/.claude/agents/token-guardian.md`

### Правила использования токенов

**ОБЯЗАТЕЛЬНО использовать:**
- Файл >2K строк → Grep или Read с offset/limit
- Файл >10K строк → ТОЛЬКО Grep
- Анализ большого проекта → Task tool (изолированный контекст)
- node_modules/ → НИКОГДА не читать

**Лимиты:**
- Контекст: 200K токенов
- Чтение файла: 25K токенов
- Размер файла: 256KB

**См. также:**
- `artvision-data/docs/TOKEN_USAGE_GUIDE.md` — полное руководство
- `~/.claude/hooks/README.md` — документация хуков

---

## ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА СОЗДАННЫХ ФАЙЛОВ

Пользователь не специалист. После создания/изменения конфигурационных файлов ОБЯЗАТЕЛЬНО:

### 1. Перед созданием конфигов
- WebSearch по официальной документации
- Прочитать существующий файл — расширять, не создавать новый
- Убедиться в правильном формате (JSON vs YAML, структура)

### 2. После создания/изменения
- Проверить синтаксис (JSON: `python3 -c "import json; json.load(open('file'))"`)
- Проверить что файл читается системой
- Для hooks/плагинов — протестировать что срабатывают

### 3. Конфликты и совместимость
- Проверить нет ли дубликатов (агенты с одинаковыми именами)
- Проверить приоритеты (проект > глобальный > плагин)
- При сомнениях — использовать агента для ревью

### Агенты для проверки
| Тип файла | Агент |
|-----------|-------|
| Код | code-reviewer |
| Архитектура | architect-reviewer |
| Конфиги | comprehensive-review |
| Security | security-auditor |


---

## ПЕРВЫЙ ЗАПУСК НА НОВОЙ МАШИНЕ

Если это новая машина или аккаунт — выполни:

```bash
curl -sL https://raw.githubusercontent.com/artvision-agency/claude-code-settings/main/scripts/full-setup.sh | bash
```

Это установит:
- 199 агентов
- 33 плагина  
- Hooks защиты
- Все настройки

После этого перезапусти Claude Code.
